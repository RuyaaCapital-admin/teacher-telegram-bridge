<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Teacher 9 â€” Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --bg: #0f1115;
        --card: #171a21;
        --text: #eef1f7;
        --muted: #9aa4b2;
        --brand: #4c8aff;
        --brand-2: #22c55e;
        --danger: #ef4444;
        --radius: 16px;
        --gap: 14px;
      }
      html, body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        font: 16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue";
      }
      .wrap {
        min-height: 100%;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      header {
        padding: 14px 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
        position: sticky; top: 0; z-index: 5;
      }
      header h1 {
        font-size: 18px; margin: 0; font-weight: 600;
      }
      .sub { color: var(--muted); font-size: 13px }
      main { padding: 16px; display: grid; gap: var(--gap) }
      .grid {
        display: grid;
        gap: var(--gap);
        grid-template-columns: 1fr;
      }
      @media (min-width: 640px) {
        .grid { grid-template-columns: repeat(2, 1fr); }
      }
      .card {
        background: var(--card);
        border-radius: var(--radius);
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px rgba(255,255,255,.05);
      }
      .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center }
      .title { font-weight: 600; margin-bottom: 6px }
      .btn {
        appearance: none; border: 0; border-radius: 14px;
        padding: 12px 14px; font-weight: 600; cursor: pointer;
        color: #fff; background: #2a2f3a; transition: transform .05s ease, opacity .2s ease;
      }
      .btn:active { transform: translateY(1px); opacity: .9 }
      .btn.brand { background: var(--brand) }
      .btn.brand2 { background: var(--brand-2) }
      .btn.ghost { background: transparent; border: 1px solid rgba(255,255,255,.1) }
      .btn.danger { background: var(--danger) }
      input, select {
        width: 100%; background: #10131a; color: var(--text);
        border: 1px solid rgba(255,255,255,.1); border-radius: 12px;
        padding: 10px 12px; outline: none;
      }
      .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px }
      .chip {
        text-align: center; padding: 8px 0; border-radius: 12px;
        background: #10131a; border: 1px solid rgba(255,255,255,.1); cursor: pointer;
        user-select: none;
      }
      .chip.active { background: rgba(76,138,255,.18); border-color: rgba(76,138,255,.6); }
      footer { padding: 16px; color: var(--muted); text-align: center; font-size: 12px }
      /* space for the floating VF widget launcher */
      .vf-spacer { height: 72px }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>ğŸ“š Teacher 9</h1>
        <div class="sub">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹</div>
      </header>

      <main>
        <!-- Quick actions -->
        <div class="grid">
          <div class="card">
            <div class="title">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¢Ù†</div>
            <div class="sub">Ø¬Ù„Ø³Ø© Ù…ÙÙ†Ø¸Ù‘Ù…Ø©: Ø´Ø±Ø­ + 3 ØªÙ…Ø§Ø±ÙŠÙ† + Ù…Ù„Ø®Øµ</div>
            <div class="row" style="margin-top: 10px">
              <button class="btn brand" id="btn-study">ğŸ“š Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¢Ù†</button>
              <button class="btn ghost" id="btn-open-chat">ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            </div>
          </div>

          <div class="card">
            <div class="title">Ø³Ø¤Ø§Ù„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø¹Ù„Ù‘Ù…</div>
            <div class="sub">Ø§Ø³Ø£Ù„ Ø¹Ù† Ù…Ø³Ø£Ù„Ø© Ø£Ùˆ ÙÙ‚Ø±Ø© Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ø±Ø³Ù…ÙŠ</div>
            <div class="row" style="margin-top: 10px">
              <input id="ask-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§â€¦" />
              <button class="btn brand2" id="btn-ask">â“ Ø§Ø³Ø£Ù„</button>
            </div>
          </div>

          <div class="card">
            <div class="title">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
            <div class="sub">Ø­Ø¯Ù‘Ø¯ ÙˆÙ‚Øª Ø§Ù„ØªØ°ÙƒÙŠØ± ÙˆØ£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
            <div class="row" style="margin-top: 10px">
              <input type="time" id="time" />
            </div>
            <div class="days" id="days"></div>
            <div class="row" style="margin-top: 12px">
              <button class="btn brand" id="btn-save-schedule">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
              <button class="btn ghost" id="btn-test-reminder">ğŸ”” Ø¬Ø±Ù‘Ø¨ ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¢Ù†</button>
            </div>
          </div>

          <div class="card">
            <div class="title">Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</div>
            <div class="sub">Ø§Ø¹Ø±Ù Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
            <div class="row" style="margin-top: 10px">
              <button class="btn" id="btn-progress">ğŸ“ˆ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</button>
              <button class="btn" id="btn-quiz">ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ±</button>
            </div>
          </div>
        </div>

        <div class="vf-spacer"></div>
      </main>

      <footer>Â© Teacher 9 â€” ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… â€¢ ÙˆØ§Ø¬Ù‡Ø© Ù…ØµØºÙ‘Ø±Ø©</footer>
    </div>

    <!-- Voiceflow chat widget -->
    <script type="text/javascript">
      // Telegram Mini App setup
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
        // optional: adapt header color
        try { tg.setHeaderColor("secondary"); } catch(e) {}
      }

      // Helpers
      const DAYS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      const daysEl = document.getElementById('days');
      DAYS.forEach((d, i) => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.dataset.value = d;
        el.textContent = ["Ø£Ø­Ø¯","Ø¥Ø«Ù†ÙŠÙ†","Ø«Ù„Ø§Ø«Ø§Ø¡","Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø®Ù…ÙŠØ³","Ø¬Ù…Ø¹Ø©","Ø³Ø¨Øª"][i];
        el.onclick = () => el.classList.toggle('active');
        // default active Sun..Thu for school nights
        if (["Sun","Mon","Tue","Wed","Thu"].includes(d)) el.classList.add('active');
        daysEl.appendChild(el);
      });

      function activeDays() {
        return Array.from(document.querySelectorAll('.chip.active')).map(c => c.dataset.value);
      }

      function openChat() {
        // Most Voiceflow widget builds support open(); if not, user taps the launcher
        try { window.voiceflow?.chat?.open?.(); } catch(e) {}
      }

      function sendToBot(payload) {
        // 1) Try to inform your DM bot via web_app_data (your webhook can parse JSON)
        try { tg?.sendData?.(JSON.stringify(payload)); } catch(e) {}
        // 2) Also send a simple text command fallback (your webhook maps it to VF)
        if (payload.type === 'action' && payload.value) {
          try { tg?.sendData?.(payload.value); } catch(e) {}
        }
      }

      // Wire buttons
      document.getElementById('btn-open-chat').onclick = openChat;

      document.getElementById('btn-study').onclick = () => {
        sendToBot({ type: 'action', value: 'study now' });
        openChat();
      };

      document.getElementById('btn-ask').onclick = () => {
        const q = (document.getElementById('ask-input').value || '').trim();
        if (!q) {
          openChat();
          return;
        }
        // Inform DM + open chat so they see the answer thread
        sendToBot({ type: 'ask', question: q });
        // As a fallback simple command (your webhook forwards to VF as text)
        sendToBot({ type: 'action', value: `ask teacher: ${q}` });
        openChat();
      };

      document.getElementById('btn-progress').onclick = () => {
        sendToBot({ type: 'action', value: 'progress' });
        openChat();
      };

      document.getElementById('btn-quiz').onclick = () => {
        sendToBot({ type: 'action', value: 'mini quiz' });
        openChat();
      };

      document.getElementById('btn-test-reminder').onclick = () => {
        sendToBot({ type: 'action', value: 'schedule' });
        openChat();
      };

      document.getElementById('btn-save-schedule').onclick = () => {
        const t = document.getElementById('time').value || '';
        const days = activeDays();
        const payload = { type: 'schedule_update', study_time: t, schedule_days: days };
        sendToBot(payload);
        // Also nudge VF to open the schedule flow
        sendToBot({ type: 'action', value: 'schedule' });
        openChat();
        // quick visual feedback
        const btn = document.getElementById('btn-save-schedule');
        const old = btn.textContent; btn.textContent = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
        setTimeout(() => btn.textContent = old, 1500);
      };
    </script>

    <!-- Load VF widget AFTER wiring the buttons -->
    <script type="text/javascript">
      (function(d,t){
        const v=d.createElement(t), s=d.getElementsByTagName(t)[0];
        v.onload=function(){
          // OPTION: tie VF session to Telegram user (if supported by your widget version)
          let userId = null;
          try { userId = tg?.initDataUnsafe?.user?.id ? `tg:${tg.initDataUnsafe.user.id}` : null; } catch(e) {}
          const config = {
            verify: { projectID: '68c6deef8969e6e999235462' },
            url: 'https://general-runtime.voiceflow.com',
            versionID: 'production',
            voice: { url: 'https://runtime-api.voiceflow.com' }
          };
          // Some builds accept a user object; ignore if not supported
          if (userId) { config.user = { id: userId }; }

          window.voiceflow.chat.load(config);
        };
        v.src="https://cdn.voiceflow.com/widget-next/bundle.mjs";
        v.type="text/javascript";
        s.parentNode.insertBefore(v,s);
      })(document,'script');
    </script>
  </body>
</html>
